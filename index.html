<html>
  <head></head>
  <body>
    <div id="textarea">
      <textarea
        id="textarea-0"
        placeholder="Type mjml here.. (v1)"
        style="width: 100%; height: 50%"
      ></textarea>
      <div id="div-0"></div>
    </div>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="blocksdk.js"></script>
    <script>
      const debounce = (fn, delay) => {
        let timeOutID;
        return function (...args) {
          if (timeOutID) {
            clearTimeout(timeOutID);
          }
          timeOutID = setTimeout(() => {
            fn(...args);
          }, delay);
        };
      };

      var sdk = new window.sfdc.BlockSDK({
        blockEditorWidth: 600,
        tabs: ["htmlblock", "stylingblock"],
      });

      sdk.getData(function (data) {
      });
      sdk.getContent(function (data) {
        if (data) {
          document.getElementById("textarea-0").value = data;
        }
      });

      sdk.getCentralData(function (centralData) {
        //console.log('Get Central Data : ' + JSON.stringify(centralData));
      });

      sdk.getUserData(function (userData) {
        //console.log('Get User Data : ' + JSON.stringify(userData));
      });
      var textAreaContent;

      function sendDatatoMC() {
        textAreaContent = document.getElementById("textarea-0").value;
        
        sdk.setContent(textAreaContent);
        sdk.setData(textAreaContent);
        var mjmlRenderedContent = renderMjml(textAreaContent);
        //sdk.setSuperContent(mjmlRenderedContent);
      }

      function renderMjml(textAreaContent) {
          var url = "https://api.mjml.io/v1/render";
          var payload = { 
            "mjml":textAreaContent
               }
          var username = "ac431a44-da36-4958-8d64-e85eff349881"
          var password = "d702e374-3670-4d14-9dab-a23dfbe9ed07"
          var authToken = "Basic " + btoa(username + ":" + password);
          var headers = { "Authorization" : authToken }

          console.log("Make post call to \n " + url )
          console.log("payload \n " + payload )
          console.log("username \n " + username )
          console.log("password \n " + password )
          console.log("authToken \n " + authToken )
          console.log("headers \n " + headers )
          axios({
            method: 'post',
            url: url,
            data: payload,
            headers : headers 
          })
          .then(result => {
            console.log(result) //To see full result 
            if (result.status == 200) {
                console.log("HTML received")
                console.log(result.data.html)
                sdk.setSuperContent(mjmlRenderedContent);
                return result.data.html
            } else {
                console.log("HTML Not received");
                console.log(result.data.errors)
            }
          })
          .catch(result => {
                console.log("HTML Not received");
                console.log(result)
          })

        return textAreaContent + " Rendered."
      }
      //Event Listener
      document.getElementById("textarea-0").addEventListener(
        "input",
        debounce((e) => {
          document.getElementById("div-0").innerHTML =
            '<font face="verdana">(' +
            document.getElementById("textarea-0").value.length +
            "/4000) " +
            (4000 - document.getElementById("textarea-0").value.length) +
            " characters left." +
            "</font>";
          sendDatatoMC();
        }, 500)
      );
      document.getElementById("div-0").innerHTML =
        '<font face="verdana">(' +
        document.getElementById("textarea-0").value.length +
        "/4000) " +
        (4000 - document.getElementById("textarea-0").value.length) +
        " characters left." +
        "</font>";
    </script>
  </body>
</html>
