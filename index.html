<html>
  <head> </head>
  <link rel="stylesheet" type="text/css" href="./css/salesforce-lightning-design-system.css" />

  <body>
<!-- COMPLETE HTML STARTS -->
      <div class="slds-grid slds-grid_vertical slds-p-around_small"><div class="slds-col image-option-input"><div class="slds-form-element"><label class="slds-form-element__label" for="selectionNameNew"><abbr class="slds-required" title="required">*</abbr>Selection Name</label><div class="slds-tooltip-trigger slds-form-element__icon" style="display: inline-block; position: static;"><button class="slds-button slds-button_icon" type="button" aria-disabled="true" aria-describedby="field-level-help-tooltip"><svg aria-hidden="true" class="slds-button__icon"><use xlink:href="../../https://distributed-marketing-content-blocks.s1.marketingcloudapps.com/free-text-block/v1/../../assets/dafb4c6441e4ff7df9afdbbf0baa4797.svg#info"></use></svg><span class="slds-assistive-text">Help</span></button><span></span></div><div class="slds-form-element__control"><input class="slds-input" id="selectionNameNew" maxlength="50" required="" type="text"></div></div></div><div class="slds-col"><div class="slds-form-element"><label class="slds-form-element__label" for="description">Guidance Message</label><div class="slds-form-element__control"><textarea class="slds-textarea description-textarea" id="description" placeholder="Leave instructions here for your business users.">Set Guidance Msg.</textarea></div></div></div><div class="slds-col"><div class="slds-form-element"><label class="slds-form-element__label" for="charLimit">Character Limit</label><div class="slds-tooltip-trigger slds-form-element__icon" style="display: inline-block; position: static;"><button class="slds-button slds-button_icon" type="button" aria-disabled="true" aria-describedby="field-level-help-tooltip"><svg aria-hidden="true" class="slds-button__icon"><use xlink:href="../../https://distributed-marketing-content-blocks.s1.marketingcloudapps.com/free-text-block/v1/../../assets/dafb4c6441e4ff7df9afdbbf0baa4797.svg#info"></use></svg><span class="slds-assistive-text">Help</span></button><span></span></div><div class="slds-form-element__control"><button class="slds-button slds-button_icon slds-button_icon-small slds-input__button_decrement" type="button"><svg aria-hidden="true" class="slds-button__icon"><use xlink:href="../../https://distributed-marketing-content-blocks.s1.marketingcloudapps.com/free-text-block/v1/../../assets/dafb4c6441e4ff7df9afdbbf0baa4797.svg#ban"></use></svg></button><input class="slds-input slds-input_counter" id="charLimit" min="50" max="4000" step="50" type="number" value="4000"><button class="slds-button slds-button_icon slds-button_icon-small slds-input__button_increment" disabled="" type="button"><svg aria-hidden="true" class="slds-button__icon"><use xlink:href="../../https://distributed-marketing-content-blocks.s1.marketingcloudapps.com/free-text-block/v1/../../assets/dafb4c6441e4ff7df9afdbbf0baa4797.svg#new"></use></svg></button></div></div></div></div>
  <!-- COMPLETE HTML ENDS -->
    <script src="blocksdk.js"></script>
    <script>
      var blockId = 1615334367096;
      const debounce = (fn, delay) => {
        let timeOutID;
        return function (...args) {
          if (timeOutID) {
            clearTimeout(timeOutID);
          }
          timeOutID = setTimeout(() => {
            fn(...args);
          }, delay);
        };
      };

      var sdk = new window.sfdc.BlockSDK({
        blockEditorWidth: 600,
        tabs: ["htmlblock", "stylingblock"],
      });

      //Grey html that reads - GSDM Plain Text Block
      greyHTMLBlock = `<table cellpadding="0 " cellspacing="0 " width="100% " role="presentation " style="min-width: 100%;  "
    class="stylingblock-content-wrapper ">
                        <tr>
                            <td class="stylingblock-content-wrapper camarker-inner ">
                                <table width="100% " height="100% " cellspacing="0 " cellpadding="0 ">
                                    <tr>
                                        <td align="center ">
                                            <p style="background-color: #D3D3D3; height:50px; line-height:50px; white-space:nowrap; ">
                                                [GSDM Plain Text Block]
                                            </p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>`;

      //HTML Text area that should be rendered when 'edit' is clicked and the value from this should be set to setData
      textAreaHTML = `</div class="dm-rich-text-block editable no-text" data-dm-block-id="1615334367096" data-content="Click To Edit">
                    <textarea id="textarea-0" placeholder="Type here.."></textarea>
                    <div id="div-0"></div>
                  </div>`;

      //HTML with AMPScript that fetches data from personalised DE
      textAreaAmpscriptHTML = `<table cellpadding="0" cellspacing="0" width="100%" role="presentation" style="min-width: 100%; "
                    class="stylingblock-content-wrapper">
                    <tr>
                        <td class="stylingblock-content-wrapper camarker-inner">%%[/* DO NOT TOUCH */\nSet @sfOrgId =
                            RegExMatch(AttributeValue("sfOrgId"),"(^[a-zA-Z0-9]{18}$)",1)\nSet @richText =
                            AttributeValue("1615334367095") /* Passed for the DM Email Preview */\nSet @objectId =
                            IIF(EMPTY(AttributeValue("sfCampaignMemberId")), AttributeValue("id"),
                            AttributeValue("sfCampaignMemberId"))\nSet @journeyId =
                            RegExMatch(AttributeValue("journeyId"),"(^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$)",1)\nSet
                            @personalizeDE = Concat("PersonalizationDE", "_" , @sfOrgId, "_", @journeyId)\nSet @personalizeId =
                            Concat(@objectId,_emailId,"1615334367095")\nIF EMPTY(@richText) THEN\n Set @richTextMsg =
                            Lookup(@personalizeDE,"value","id",@personalizeId)\nELSE THEN\n Set @richTextMsg = @richText\nENDIF\nSet
                            @richTextMsg = Concat('<div class="dm-rich-text-block" data-dm-block-id="1615334367095">', @richTextMsg,
                                '</div>')\n]%%\n%%=v(@richTextMsg)=%%\n%%[*/ DO NOT TOUCH */]%%</td>
                    </tr>
                </table>`;

      //sdk.setSuperContent(textBlockHTML);

      //Temp:
      var selectionName = `<div data-marker="wrapper" style="" class="stylingblock-content-wrapper">
                            <table width="100%" height="100%" cellspacing="0" cellpadding="0">
                                <tbody>
                                    <tr>
                                        <td align="center">
                                            <p style="background-color: #D3D3D3; height:50px; line-height:50px; white-space:nowrap;">[`+document.getElementById("selectionNameNew").value+`]</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
      `;
      //MK: 17Mar-modified this
      /* 
        <div class="dm-rich-text-block editable no-text" data-dm-block-id="`+blockId+`" data-content="Click To Edit">
            <span class="dm-icon"><svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" viewBox="0 0 52 52">
                    <g fill="#fff">
                        <path
                            d="m9.5 33.4l8.9 8.9c0.4 0.4 1 0.4 1.4 0l22.2-22.3c0.4-0.4 0.4-1 0-1.4l-8.8-8.8c-0.4-0.4-1-0.4-1.4 0l-22.3 22.3c-0.4 0.4-0.4 1 0 1.3z m26.6-27.7c-0.4 0.4-0.4 1 0 1.4l8.8 8.8c0.4 0.4 1 0.4 1.4 0l2.5-2.5c1.6-1.5 1.6-3.9 0-5.5l-4.7-4.7c-1.6-1.6-4.1-1.6-5.7 0l-2.3 2.5z m-34 42.5c-0.2 1 0.7 1.9 1.7 1.7l10.9-2.6c0.4-0.1 0.7-0.3 0.9-0.5l0.2-0.2c0.2-0.2 0.3-0.9-0.1-1.3l-9-9c-0.4-0.4-1.1-0.3-1.3-0.1l-0.2 0.2c-0.3 0.3-0.4 0.6-0.5 0.9l-2.6 10.9z">
                        </path>
                    </g>
                </svg></span>
        </div>

      */
      var editableSectionName = 
      `<div data-dm-block-id="`+blockId+`" data-content="Click To Edit (B)">
      </div>`;
      console.log("[Debug]: editableSectionName => "+ editableSectionName);
      sdk.setContent(editableSectionName);
      sdk.setSuperContent(greyHTMLBlock);

      console.log("[Mathes - 2] : Before opening selectionNameNew|" + document.getElementById("selectionNameNew").value + "|" + document.getElementById("description").value)


      /* -SET METADATA START- */
      var customBlockData = new Object();
      customBlockData.dmRichTextBlock = new Object();
      customBlockData.dmRichTextBlock.dmBlockId = blockId;
      customBlockData.dmRichTextBlock.version = 1;
      customBlockData.dmRichTextBlock.selectionName = document.getElementById("selectionNameNew").value + "<Initial Load>";
      customBlockData.dmRichTextBlock.description = document.getElementById("description").value;
      customBlockData.dmRichTextBlock.charLimit = document.getElementById("charLimit").value;
      /* -END- */

      sdk.getData(function (data) { 
        console.log("MATHES - see this get data value --> " + JSON.stringify(data));
        if (data) {
          document.getElementById("selectionNameNew").value = data["dmRichTextBlock"]["selectionName"] + "<GetData>";
        }
          sdk.setData(customBlockData, function (data) {
          console.log(
            "Received metadata from setData within ***getData*** ==> " + JSON.stringify(data)
          );
        });
      });
      

      /* sdk.setData(customBlockData, function (data) {
        console.log(
          "Received metadata from setData ==> " + JSON.stringify(data)
        );
      });*/


      sdk.setBlockEditorWidth("500px", function (data) {
        console.log("setBlockEditorWidth --> " + JSON.stringify(data));
      });
  /* 
MATHES - see this get data value --> {"dmRichTextBlock":{"dmBlockId":1615334367096,"version":1,"selectionName":"SF DM Block","description":"Set Guidance Msg.","charLimit":"4000"}}

  */

      sdk.getContent(function (data) {
        if (data) {
          //document.getElementById("textarea-0").value = data;
          console.log("Data in getContent --> " + JSON.stringify(data));
        }
      });

      sdk.getCentralData(function (centralData) {
        console.log("Get Central Data : " + JSON.stringify(centralData));
      });

      sdk.getUserData(function (userData) {
        console.log("Get User Data : " + JSON.stringify(userData));
      });
      
      var textAreaContent;

       function sendDatatoMC() {
        selectionNameNewContent = document.getElementById("selectionNameNew").value;
        /* -SET METADATA START- */
        var customBlockData = new Object();
        customBlockData.dmRichTextBlock = new Object();
        customBlockData.dmRichTextBlock.dmBlockId = 1615334367096;
        customBlockData.dmRichTextBlock.version = 1;
        customBlockData.dmRichTextBlock.selectionName = document.getElementById("selectionNameNew").value + "<Inside Debounce>";
        customBlockData.dmRichTextBlock.description = document.getElementById("description").value;
        customBlockData.dmRichTextBlock.charLimit = document.getElementById("charLimit").value;

        sdk.setData(customBlockData, function (data) {
          console.log(
            "Received metadata from setData within Debounce ==> " + JSON.stringify(data)
          );
        });
              /* -END- */

      } 

      //Event Listener
      document.getElementById("selectionNameNew").addEventListener(
        "input",
        debounce((e) => {
          console.log("[Debug]: Event Listner after debounce --> " + JSON.stringify(e));
          sendDatatoMC();
        }, 500)
      );
      
    </script>
  </body>
</html>
